name: ğŸ”’ Security & Maintenance

on:
  schedule:
    # Run security checks weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch: # Allow manual triggering
  push:
    branches: [ main ]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/security.yml'

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi
        
    - name: ğŸ”’ Run Security Audit
      run: |
        echo "ğŸ” Running npm security audit..."
        npm audit --audit-level=moderate || {
          echo "âš ï¸ Security vulnerabilities found!"
          echo "ğŸ“‹ Detailed audit report:"
          npm audit --json > audit-report.json
          cat audit-report.json
          exit 1
        }
        
    - name: ğŸ“Š Dependency Analysis
      run: |
        echo "ğŸ“¦ Dependency Analysis:"
        echo "ğŸ“ˆ Total dependencies: $(npm list --depth=0 2>/dev/null | grep -c 'â”œ\|â””' || echo '0')"
        echo "ğŸ” Outdated packages:"
        npm outdated || echo "âœ… All packages are up to date"
        
    - name: ğŸ§¹ License Check
      run: |
        echo "ğŸ“„ License compliance check:"
        echo "ğŸ” Checking package licenses..."
        npm list --depth=0 2>/dev/null | grep -E 'MIT|ISC|BSD|Apache' || echo "âš ï¸ Non-standard licenses found"
        
    - name: ğŸ“ File Security Scan
      run: |
        echo "ğŸ” File security scan:"
        echo "ğŸš« Checking for sensitive files..."
        # Check for common sensitive file patterns
        find . -name "*.env*" -o -name "*.key" -o -name "*.pem" -o -name "*.p12" | head -10
        echo "ğŸ”’ Checking for hardcoded secrets..."
        # Simple grep for common secret patterns
        grep -r -i "password\|secret\|token\|key" --include="*.js" --include="*.ts" src/ || echo "âœ… No obvious secrets found"
        
    - name: ğŸ“‹ Generate Security Report
      if: always()
      run: |
        echo "ğŸ›¡ï¸ Security Report Summary:"
        echo "ğŸ“… Scan Date: $(date)"
        echo "ğŸ” Scan Type: Automated Security Audit"
        echo "ğŸ“Š Status: $(if [ $? -eq 0 ]; then echo 'PASSED'; else echo 'ISSUES_FOUND'; fi)"
        echo "ğŸ“ Next scheduled scan: Next Sunday 2 AM UTC"

  dependency-update:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        if [ -f package-lock.json ]; then
          npm ci
        else
          npm install
        fi
        
    - name: ğŸ”„ Check for Updates
      id: updates
      run: |
        echo "ğŸ” Checking for available updates..."
        UPDATE_OUTPUT=$(npm outdated --json || echo '{}')
        echo "updates=$UPDATE_OUTPUT" >> $GITHUB_OUTPUT
        
        if [ "$UPDATE_OUTPUT" != "{}" ] && [ "$UPDATE_OUTPUT" != "" ]; then
          echo "ğŸ”„ Updates available!"
          echo "has_updates=true" >> $GITHUB_OUTPUT
        else
          echo "âœ… All dependencies are up to date"
          echo "has_updates=false" >> $GITHUB_OUTPUT
        fi
        
    - name: ğŸ“ Create Update Report
      if: steps.updates.outputs.has_updates == 'true'
      run: |
        echo "ğŸ“‹ Dependency Update Report" > update-report.md
        echo "" >> update-report.md
        echo "The following dependencies have updates available:" >> update-report.md
        echo "" >> update-report.md
        npm outdated >> update-report.md || true
        echo "" >> update-report.md
        echo "âš ï¸ Please review and update these dependencies manually." >> update-report.md
        echo "ğŸ“… Report generated: $(date)" >> update-report.md
        
        echo "ğŸ“„ Update report generated:"
        cat update-report.md

